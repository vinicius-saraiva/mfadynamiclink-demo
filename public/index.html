<!DOCTYPE html>
<html>
<head>
    <style>
        .container { max-width: 600px; margin: 40px auto; padding: 20px; }
        .payment-details { 
            background: #f5f5f5; 
            padding: 15px; 
            margin: 20px 0;
            border-radius: 5px;
        }
        .warning { color: #ff4444; }
        .info { color: #4444ff; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Secure Payment Authorization Demo</h2>
        <div id="userInfo" style="margin-bottom: 20px; padding: 10px; background: #e8f5e9; border-radius: 5px; display: none;">
            <p>Logged in as: <span id="currentUser"></span></p>
            <button onclick="logout()" style="padding: 5px 10px;">Logout</button>
        </div>
        <div id="loginPrompt" style="margin-bottom: 20px; padding: 10px; background: #ffebee; border-radius: 5px; display: none;">
            <p>Please register or login first</p>
            <a href="/register.html" class="button">Register Authentication Method</a>
        </div>
        <form id="paymentForm">
            <div>
                <label for="amount">Amount:</label>
                <input type="number" id="amount" required min="1" step="0.01">
            </div>
            <div style="margin-top: 10px;">
                <label for="currency">Currency:</label>
                <select id="currency" required>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="BRL">BRL</option>
                </select>
            </div>
            <div style="margin-top: 10px;">
                <label for="beneficiaryId">Beneficiary ID:</label>
                <input type="text" id="beneficiaryId" required>
            </div>
            <div style="margin-top: 10px;">
                <label for="beneficiaryName">Beneficiary Name:</label>
                <input type="text" id="beneficiaryName" required>
            </div>
            <button type="submit" style="margin-top: 20px;">Authorize Payment</button>
        </form>

        <div class="payment-details" id="paymentDetails" style="display: none;">
            <h3>Payment Details Being Authorized:</h3>
            <p>Amount: <span id="confirmedAmount"></span> <span id="confirmedCurrency"></span></p>
            <p>Beneficiary ID: <span id="confirmedBeneficiary"></span></p>
            <p>Beneficiary Name: <span id="confirmedBeneficiaryName"></span></p>
            <p class="warning">⚠️ Any attempt to modify these details after MFA generation will invalidate the authorization.</p>
        </div>

        <div style="margin-top: 20px; text-align: center;">
            <p>First time here? <a href="/register.html">Register your authentication method</a></p>
        </div>
    </div>

    <script>
        const userId = localStorage.getItem('authUserId');
        const userEmail = localStorage.getItem('authUserEmail');
        
        if (userId) {
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('currentUser').textContent = userEmail || userId;
            document.getElementById('loginPrompt').style.display = 'none';
        } else {
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('loginPrompt').style.display = 'block';
            document.getElementById('paymentForm').style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('authUserId');
            localStorage.removeItem('authUserEmail');
            window.location.reload();
        }

        document.getElementById('paymentForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const userId = localStorage.getItem('authUserId');
            if (!userId) {
                alert('Please register first');
                window.location.href = '/register.html';
                return;
            }
            
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;
            const beneficiaryId = document.getElementById('beneficiaryId').value;
            const beneficiaryName = document.getElementById('beneficiaryName').value;

            try {
                const response = await fetch('/api/payment/authorize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        amount: amount,
                        currency: currency,
                        beneficiaryId: beneficiaryId,
                        beneficiaryName: beneficiaryName
                    })
                });

                const data = await response.json();
                console.log('Server response:', data);

                if (data.requiresChallenge && data.challengeUrl) {
                    // Format amount based on currency
                    const formattedAmount = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: currency
                    }).format(amount);

                    // Display the payment details being authorized
                    document.getElementById('paymentDetails').style.display = 'block';
                    document.getElementById('confirmedAmount').textContent = formattedAmount;
                    document.getElementById('confirmedBeneficiary').textContent = beneficiaryId;
                    document.getElementById('confirmedBeneficiaryName').textContent = beneficiaryName;

                    // Store the original values in sessionStorage
                    sessionStorage.setItem('originalAmount', amount);
                    sessionStorage.setItem('originalCurrency', currency);
                    sessionStorage.setItem('originalBeneficiary', beneficiaryId);
                    sessionStorage.setItem('originalBeneficiaryName', beneficiaryName);

                    // Redirect to MFA challenge after a short delay
                    setTimeout(() => {
                        window.location.replace(data.challengeUrl);
                    }, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error during authorization: ' + error.message);
            }
        };
    </script>
</body>
</html> 