<!DOCTYPE html>
<html>
<head>
    <style>
        .container { max-width: 600px; margin: 40px auto; padding: 20px; }
        .payment-details { 
            background: #f5f5f5; 
            padding: 15px; 
            margin: 20px 0;
            border-radius: 5px;
        }
        .warning { color: #ff4444; }
        .info { color: #4444ff; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Secure Payment Authorization Demo</h2>
        <p class="info">This demo shows how MFA is dynamically linked to payment details. 
           If you modify the amount or beneficiary after generating the MFA challenge, the authorization will fail.</p>

        <form id="paymentForm">
            <div>
                <label for="amount">Amount:</label>
                <input type="number" id="amount" required min="1" step="0.01">
            </div>
            <div style="margin-top: 10px;">
                <label for="currency">Currency:</label>
                <select id="currency" required>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="BRL">BRL</option>
                </select>
            </div>
            <div style="margin-top: 10px;">
                <label for="beneficiaryId">Beneficiary ID:</label>
                <input type="text" id="beneficiaryId" required>
            </div>
            <div style="margin-top: 10px;">
                <label for="beneficiaryName">Beneficiary Name:</label>
                <input type="text" id="beneficiaryName" required>
            </div>
            <button type="submit" style="margin-top: 20px;">Authorize Payment</button>
        </form>

        <div class="payment-details" id="paymentDetails" style="display: none;">
            <h3>Payment Details Being Authorized:</h3>
            <p>Amount: <span id="confirmedAmount"></span> <span id="confirmedCurrency"></span></p>
            <p>Beneficiary ID: <span id="confirmedBeneficiary"></span></p>
            <p>Beneficiary Name: <span id="confirmedBeneficiaryName"></span></p>
            <p class="warning">⚠️ Any attempt to modify these details after MFA generation will invalidate the authorization.</p>
        </div>
    </div>

    <script>
        document.getElementById('paymentForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;
            const beneficiaryId = document.getElementById('beneficiaryId').value;
            const beneficiaryName = document.getElementById('beneficiaryName').value;

            try {
                const response = await fetch('/api/payment/authorize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'test-user-123',
                        amount: amount,
                        currency: currency,
                        beneficiaryId: beneficiaryId,
                        beneficiaryName: beneficiaryName
                    })
                });

                const data = await response.json();
                console.log('Server response:', data);

                if (data.requiresChallenge && data.challengeUrl) {
                    // Format amount based on currency
                    const formattedAmount = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: currency
                    }).format(amount);

                    // Display the payment details being authorized
                    document.getElementById('paymentDetails').style.display = 'block';
                    document.getElementById('confirmedAmount').textContent = formattedAmount;
                    document.getElementById('confirmedBeneficiary').textContent = beneficiaryId;
                    document.getElementById('confirmedBeneficiaryName').textContent = beneficiaryName;

                    // Store the original values in sessionStorage
                    sessionStorage.setItem('originalAmount', amount);
                    sessionStorage.setItem('originalCurrency', currency);
                    sessionStorage.setItem('originalBeneficiary', beneficiaryId);
                    sessionStorage.setItem('originalBeneficiaryName', beneficiaryName);

                    // Redirect to MFA challenge after a short delay
                    setTimeout(() => {
                        window.location.replace(data.challengeUrl);
                    }, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error during authorization: ' + error.message);
            }
        };
    </script>
</body>
</html> 